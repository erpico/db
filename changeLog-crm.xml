<?xml version="1.0" encoding="UTF-8" standalone="no"?><databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd"                   logicalFilePath="erpico_crm">  <changeSet id="2014-07-17-01" author="kae">    <sql><![CDATA[      ALTER TABLE `sms_pool` CHANGE COLUMN `message_id` `message_id` VARCHAR(127) NOT NULL DEFAULT '0';    ]]></sql>  </changeSet>  <changeSet id="2014-07-17-02" author="kae">    <sql><![CDATA[      ALTER TABLE `sms_in` CHANGE COLUMN `message_id` `message_id` VARCHAR(127) NOT NULL DEFAULT '0'  ;    ]]></sql>  </changeSet>  <changeSet id="2014-07-17-03" author="kae">    <sql><![CDATA[      CREATE TABLE `order_call_history` (        `id` int(11) NOT NULL AUTO_INCREMENT,        `order_id` int(11) NOT NULL,        `call_id` bigint(20) NOT NULL,        `created` datetime NOT NULL,        PRIMARY KEY (`id`)      );    ]]></sql>  </changeSet>  <changeSet id="2014-07-17-04" author="kae">    <sql><![CDATA[      INSERT INTO `cfg_setting` (`handle`, `val`) VALUES ('crm.map.enabled', '0');    ]]></sql>  </changeSet>  <changeSet id="2014-07-17-05" author="mrk">    <sql><![CDATA[      CREATE TABLE `taxi_city_services` (        `city_id` int(10) NOT NULL,        `service_id` int(10) NOT NULL,        PRIMARY KEY (`city_id`,`service_id`)      );    ]]></sql>  </changeSet>  <changeSet id="2014-07-17-06" author="mrk">    <sql>      <![CDATA[      ALTER TABLE `taxi_prices`         ADD COLUMN `city_id` INT(10) NOT NULL AFTER `service_id`,        DROP PRIMARY KEY,        ADD PRIMARY KEY (`service_id`, `city_id`, `class_id`);    ]]></sql>  </changeSet>  <changeSet id="2014-07-17-07" author="mrk">    <sql>      <![CDATA[      SELECT @val := val+0 FROM `cfg_setting` where `handle` = 'crm.city.id';      UPDATE `taxi_prices` SET `city_id` = SUBSTRING_INDEX(@val, ';', 1);      insert into `taxi_city_services` (`city_id`, `service_id`) select SUBSTRING_INDEX(@val, ';', 1), `id` from `taxi_service` where `id` > 6;    ]]>    </sql>  </changeSet>  <changeSet id="2014-09-02-01" author="kae">    <sql><![CDATA[      CREATE  TABLE IF NOT EXISTS `billing_account_type` (        `id` INT NOT NULL AUTO_INCREMENT,        `name` VARCHAR(255) NOT NULL,        PRIMARY KEY (`id`))      ENGINE = InnoDB;    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-02" author="kae">    <sql><![CDATA[      CREATE  TABLE IF NOT EXISTS `billing_account` (        `id` INT NOT NULL AUTO_INCREMENT ,        `kind` TINYINT(1) NOT NULL ,        `owner_id` INT NOT NULL ,        `type_id` INT NOT NULL ,        `primary` TINYINT(1) NOT NULL DEFAULT 0 ,        `balance` DECIMAL(10,2) NOT NULL DEFAULT 0.0 ,        PRIMARY KEY (`id`) ,        INDEX `fk_billing_account_type_idx` (`type_id` ASC) ,        CONSTRAINT `fk_billing_account_type`          FOREIGN KEY (`type_id` )          REFERENCES `billing_account_type` (`id` )          ON DELETE RESTRICT          ON UPDATE RESTRICT)      ENGINE = InnoDB;    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-03" author="kae">    <sql><![CDATA[      CREATE  TABLE IF NOT EXISTS `client_billing_rule` (        `id` INT NOT NULL AUTO_INCREMENT,        `action` TINYINT(2) NOT NULL,        `billing_account_type_id` INT NOT NULL,        PRIMARY KEY (`id`),        INDEX `fk_client_billing_rule_billing_account_type1_idx` (`billing_account_type_id` ASC),        CONSTRAINT `fk_client_billing_rule_billing_account_type1`          FOREIGN KEY (`billing_account_type_id` )          REFERENCES `billing_account_type` (`id` )          ON DELETE RESTRICT          ON UPDATE RESTRICT)      ENGINE = InnoDB;    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-04" author="kae">    <sql><![CDATA[      INSERT INTO `billing_account_type` (`id`, `name`) VALUES (1, 'Основной счет');      INSERT INTO `billing_account_type` (`id`, `name`) VALUES (2, 'Бонусный счет');      /*        bm_Unknown = 0,        bm_User   = 1,        bm_Service = 2,        bm_Megadiscount = 3,        bm_Bonus = 4,        bm_BonusFromFriend = 5,        bm_RegisterWithFriend = 6,        bm_WWW_Service = 7,        bm_DeliveryFromOrder = 8,        bm_VipPlatinumCard = 9,        bm_Checkpoint = 10,        bm_ServiceCredit = 11       */      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('0', '1');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('1', '1');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('2', '1');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('3', '1');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('4', '2');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('5', '2');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('6', '2');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('7', '1');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('8', '1');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('9', '1');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('10', '1');      INSERT INTO `client_billing_rule` (`action`, `billing_account_type_id`) VALUES ('11', '1');    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-05" author="kae">    <sql>      <![CDATA[      ALTER TABLE `clients_billing`        ADD COLUMN `account_id` INT NULL AFTER `client_id`;    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-06" author="kae">    <createProcedure><![CDATA[      CREATE PROCEDURE `create_clients_billing_accounts`() BEGIN        DECLARE done INT DEFAULT 0;        DECLARE client_id DECIMAL(10, 2);        DECLARE balance DECIMAL(10, 2);        DECLARE cur CURSOR FOR SELECT c.id, c.balans FROM clients c ORDER BY c.id;        DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;        PREPARE update_clients_billing_stmt FROM 'UPDATE clients_billing SET `account_id`=? WHERE `client_id`=?';        SET @account_id=0;        SET @client_id=0;        OPEN cur;        read_loop: LOOP          FETCH cur INTO client_id, balance;          IF done THEN            LEAVE read_loop;          END IF;          SET @client_id=client_id;          SET @account_id = @account_id + 1;          INSERT INTO `billing_account` (`id`, `kind`, `owner_id`, `type_id`, `primary`, `balance`)            VALUES (@account_id, '0', @client_id, '1', '1', balance);          EXECUTE update_clients_billing_stmt USING @account_id, @client_id;          SET @account_id = @account_id + 1;          INSERT INTO `billing_account` (`id`, `kind`, `owner_id`, `type_id`, `primary`, `balance`)            VALUES (@account_id, '0', @client_id, '2', '0', '0.0');          COMMIT;        END LOOP;        DEALLOCATE PREPARE update_clients_billing_stmt;        SET @account_id = @account_id + 1;        SET @SQL := CONCAT('ALTER TABLE billing_account AUTO_INCREMENT =  ', @account_id);        PREPARE _stmt FROM @SQL;        EXECUTE _stmt;        DEALLOCATE PREPARE _stmt;        CLOSE cur;      END;    ]]></createProcedure>  </changeSet>  <changeSet id="2014-09-02-07" author="kae">    <sql><![CDATA[      call `create_clients_billing_accounts`();    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-08" author="kae">    <sql><![CDATA[       DROP PROCEDURE `create_clients_billing_accounts`;    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-09" author="kae">    <sql><![CDATA[      ALTER TABLE `clients_billing`        CHANGE COLUMN `account_id` `account_id` INT(11) NOT NULL,        ADD INDEX `account_id` (`account_id` ASC) ;    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-10" author="kae">    <sql><![CDATA[      ALTER TABLE `billing_account`        ADD UNIQUE INDEX `uk_billing_account_kind_owner_type` (`kind` ASC, `owner_id` ASC, `type_id` ASC) ;    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-11" author="kae">    <sql><![CDATA[      ALTER TABLE `billing_account`        ADD INDEX `idx_billing_account_kind_owner` (`kind` ASC, `owner_id` ASC) ;    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-12" author="kae">    <sql><![CDATA[      ALTER TABLE `client_billing_rule`        ADD UNIQUE INDEX `uk_client_billing_rule_action` (`action` ASC) ;    ]]></sql>  </changeSet>  <changeSet id="2014-09-02-13" author="kae">    <sql><![CDATA[      ALTER TABLE `clients` DROP COLUMN `balans`;    ]]></sql>  </changeSet>  <changeSet id="2014-09-09-1" author="kae">    <sql>          <![CDATA[      CREATE  TABLE `executor_alarm` (        `id` INT NOT NULL AUTO_INCREMENT ,        `executor_id` INT NOT NULL ,        `created` DATETIME NOT NULL ,        `active` TINYINT NOT NULL ,        PRIMARY KEY (`id`) );    ]]></sql>  </changeSet></databaseChangeLog>